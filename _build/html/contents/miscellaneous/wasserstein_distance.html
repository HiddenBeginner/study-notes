
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Wasserstein distance 구현하기 &#8212; 공부 기록</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Quantile Regression" href="quantile_regression.html" />
    <link rel="prev" title="Define-and-run vs Define-by-run" href="define_and_by_run.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">공부 기록</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    공부 기록
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  머신러닝/딥러닝 근본적 내용들
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../fundamental/beyond_batchnorm.html">
   Beyond BatchNorm
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fundamental/230420_ulc.html">
   Uncertainty-aware Label Correction
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  강화학습 논문 정리
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../rl_papers/AlphaGoZero.html">
   AlphaGo Zero
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../rl_papers/SUNRISE.html">
   SUNRISE
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../rl_papers/DreamerV1.html">
   Dreamer
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  잡학사전
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="define_and_by_run.html">
   Define-and-run vs Define-by-run
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Wasserstein distance 구현하기
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="quantile_regression.html">
   Quantile Regression
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  튜토리얼
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../tutorials/2023-04-20_CartRacing-v2_DQN.html">
   Control CartRacing-v2 environment using DQN from scratch
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/docs/contents/miscellaneous/wasserstein_distance.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fcontents/miscellaneous/wasserstein_distance.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>

</a>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/contents/miscellaneous/wasserstein_distance.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#p-wasserstein-distance">
   <span class="math notranslate nohighlight">
    \(p\)
   </span>
   -Wasserstein distance의 정의
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#analytic-solution">
   1차원 데이터일 때 정의에 대한 analytic solution
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   Wasserstein distance 구현하기
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   식
   <code class="xref eq docutils literal notranslate">
    <span class="pre">
     analytic-solution
    </span>
   </code>
   증명
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id3">
   참고문헌
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Wasserstein distance 구현하기</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#p-wasserstein-distance">
   <span class="math notranslate nohighlight">
    \(p\)
   </span>
   -Wasserstein distance의 정의
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#analytic-solution">
   1차원 데이터일 때 정의에 대한 analytic solution
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   Wasserstein distance 구현하기
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   식
   <code class="xref eq docutils literal notranslate">
    <span class="pre">
     analytic-solution
    </span>
   </code>
   증명
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id3">
   참고문헌
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="wasserstein-distance">
<h1>Wasserstein distance 구현하기<a class="headerlink" href="#wasserstein-distance" title="Permalink to this headline">#</a></h1>
<p>이름부터 무시무시한 Wassertstein distance. 이름만 무서우면 다행이지만 이 녀석의 정의 또한 무섭다.
Wasserstein distance는 두 확률 분포 사이의 거리를 측정할 때 사용된다.
그런데 우리가 실제로 갖고 있는 것은 어느 확률 분포에서 샘플링된지 모르는 데이터셋이며, 두 데이터셋 사이의 Wasserstein distance를 구하는 것이 목표이다.
이번 포스팅에서는 확률 분포가 아닌 두 데이터셋이 주어졌을 때 Wasserstein distance를 계산하는 방법에 대해서 알아본다.</p>
<p>포스팅은 다음과 같이 구성되어 있다.
먼저, Wasserstein distance의 정의를 살펴본다.
다음으로 1차원 데이터에 한정하여 정의에 해당하는 값을 해석적으로 구해볼 것이다.
그리고 그 값을 코드로 구현하여 거리를 직접 계산해볼 것이다.</p>
<hr class="docutils" />
<section id="p-wasserstein-distance">
<h2><span class="math notranslate nohighlight">\(p\)</span>-Wasserstein distance의 정의<a class="headerlink" href="#p-wasserstein-distance" title="Permalink to this headline">#</a></h2>
<p>먼저, Wasserstein distance의 정의에 대해서 알아보자. 위키피디아의 정의를 그대로 따왔다.</p>
<div class="tip admonition">
<p class="admonition-title"><strong><span class="math notranslate nohighlight">\(p\)</span>-Wasserstein distance</strong></p>
<p>Let <span class="math notranslate nohighlight">\((\mathcal{X},d)\)</span> be a metric space that is a Radon space, and let <span class="math notranslate nohighlight">\(p \in [1, \infty)\)</span>. For any two marginal measures <span class="math notranslate nohighlight">\(\mu\)</span> and <span class="math notranslate nohighlight">\(\nu\)</span> on <span class="math notranslate nohighlight">\(\mathcal{X}\)</span>, the Wasserstein distance of order <span class="math notranslate nohighlight">\(p\)</span> between <span class="math notranslate nohighlight">\(\mu\)</span> and <span class="math notranslate nohighlight">\(\nu\)</span> is given by</p>
<div class="math notranslate nohighlight">
\[
W_p(\mu, \nu) =  \left( \inf\limits_{\gamma \in \Gamma (\mu, \nu)} \displaystyle\int_{\mathcal{X} \times \mathcal{X}} d(x, y)^p d\gamma(x,y) \right)^{1/p},
\]</div>
<p>where <span class="math notranslate nohighlight">\(\Gamma(\mu, \nu)\)</span> is the set of all couplings of <span class="math notranslate nohighlight">\(\mu\)</span> and <span class="math notranslate nohighlight">\(\nu\)</span>. A coupling <span class="math notranslate nohighlight">\(\gamma(\mu, \nu)\)</span> is a joint probability measure on <span class="math notranslate nohighlight">\(\mathcal{X} \times \mathcal{X}\)</span> whose marginals are <span class="math notranslate nohighlight">\(\mu\)</span> and <span class="math notranslate nohighlight">\(\nu\)</span>, respectively.</p>
</div>
<br>
<p>위의 정의를 온전히 이해하기 위해서는 수학과 대학원 확률론 지식 또는 최소 대학원 해석학 지식이 필요하다. 물론 나는 없다.
그래도 공부한 것을 바탕으로 정의를 읽어보자면 다음과 같다 (어지러우면 다음으로 문단으로 넘어가도 좋다).</p>
<ul class="simple">
<li><p>Wasserstein distance는 두 probability measure 뮤 <span class="math notranslate nohighlight">\(\mu\)</span>와 누 <span class="math notranslate nohighlight">\(\nu\)</span>에 대해서 정의되는 것이다. Probability measure란 각 사건에 확률을 부여하는 함수 또는 규칙이며, 그냥 probability distribution이라고 생각해도 좋다. 조금 더 과감히 말하면 probability density function 또는 probability mass function으로 생각해도 좋다.</p></li>
<li><p>두 Probability measure의 sample space에 있는 원소들을 짝짓는 모든 coupling <span class="math notranslate nohighlight">\(\gamma(\mu, \mu)\)</span> 중에 <span class="math notranslate nohighlight">\(\displaystyle\int_{\mathcal{X} \times \mathcal{X}} d(x, y)^p d\gamma(x,y)\)</span>의 최소값을 찾으면 그것의 <span class="math notranslate nohighlight">\(\frac{1}{p}\)</span> 제곱이 <span class="math notranslate nohighlight">\(p\)</span>-Wasserstein distance이다. 여기서 coupling을 joint distribution으로 이해해도 좋다.</p></li>
<li><p>Wasserstein distance의 정의를 Earth mover’s distance (흙 옮기는 기계)나 optimal transport problem (최적 운송 문제) 관점으로 해석할 수 있다. 한 확률 분포에 있는 mass를 최소의 비용으로 다른 확률 분포로 운송하는 것이다. 한 확률 분포의 <span class="math notranslate nohighlight">\(x\)</span> 위치에 있는 mass를 다른 확률 분포의 <span class="math notranslate nohighlight">\(y\)</span> 위치로 옮길 때 발생하는 비용 <span class="math notranslate nohighlight">\(d(x, y)\)</span>의 기댓값이 최소로 되도록 coupling을 찾는 것이다.</p></li>
</ul>
<br>
<p>1차원 sample space 가정 등 여러 가지를 가정하면, 다음과 같이 우리에게 익숙한 용어로 정의를 다시 적어줄 수 있다.</p>
<div class="tip admonition">
<p class="admonition-title"><strong><span class="math notranslate nohighlight">\(p\)</span>-Wasserstein distance</strong></p>
<p>For any two real-valued random variables <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(Y\)</span>, with probability density functions <span class="math notranslate nohighlight">\(f_X\)</span> and <span class="math notranslate nohighlight">\(f_Y\)</span>, the Wasserstein distance between <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(Y\)</span> is given by</p>
<div class="math notranslate nohighlight">
\[
    W_p(X, Y) =  \left( \inf\limits_{f_{XY} \in \mathcal{F}} \displaystyle\int_{\mathbb{R}}\int_{\mathbb{R}} f_{XY}(x, y) |x-y|^p \, dx \, dy \right)^{1/p},
\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathcal{F}\)</span> is the set of all joint probability of <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(Y\)</span> with marginal distributions <span class="math notranslate nohighlight">\(f_X\)</span> and <span class="math notranslate nohighlight">\(f_Y\)</span>.</p>
</div>
<p>확률 용어에 익숙한 분들이라면 위 단순화된 정의는 쉽게 이해될 것이다.
확률 변수 <span class="math notranslate nohighlight">\(X\)</span>와 <span class="math notranslate nohighlight">\(Y\)</span>에 대한 모든 가능한 joint distribution <span class="math notranslate nohighlight">\(f_{XY}\)</span>에 대해서 <span class="math notranslate nohighlight">\(\displaystyle\int_{\mathbb{R}}\int_{\mathbb{R}} f_{XY}(x, y) |x-y|^p \, dx \, dy\)</span>의 최소값을 찾는 것이다. 이 적분을 자세히 보면, 확률 변수 <span class="math notranslate nohighlight">\(|X-Y|^p\)</span>의 기댓값 <span class="math notranslate nohighlight">\(\mathbb{E}_{XY}\left[ |x-y|^p \right]\)</span>인 것을 알 수 있다.</p>
</section>
<hr class="docutils" />
<section id="analytic-solution">
<h2>1차원 데이터일 때 정의에 대한 analytic solution<a class="headerlink" href="#analytic-solution" title="Permalink to this headline">#</a></h2>
<p>정의에 따라 Wasserstein distance를 계산한다면 이 세상의 모든 joint distribution <span class="math notranslate nohighlight">\(f_{XY}(x, y)\)</span>에 대해서 <span class="math notranslate nohighlight">\(\mathbb{E}_{XY}\left[ |x-y|^p \right]\)</span>을 계산해보고 그 중 최소값을 구하는 최적화 문제를 풀어야 할 것이다. 너무나도 당연하게 많은 경우 이 행위는 intractable할 것이다. 근데 정말 다행히도 1차원 확률 변수 <span class="math notranslate nohighlight">\(X\)</span>와 <span class="math notranslate nohighlight">\(Y\)</span>에 대해서는 정의의 infimum 값이 해석적으로 계산되어 있다. 다음 statement를 보자.</p>
<div class="tip admonition">
<p class="admonition-title"><strong><span class="math notranslate nohighlight">\(p\)</span>-Wasserstein distance</strong></p>
<p>For any two real-valued random variables <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(Y\)</span>, with cumulative distribution functions <span class="math notranslate nohighlight">\(F_X\)</span> and <span class="math notranslate nohighlight">\(F_Y\)</span>, the Wasserstein distance between <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(Y\)</span> is given by</p>
<div class="math notranslate nohighlight" id="equation-analytic-solution">
<span class="eqno">(1)<a class="headerlink" href="#equation-analytic-solution" title="Permalink to this equation">#</a></span>\[
    W_p(X, Y) = \left(\displaystyle\int_0^1 |F_X^{-1}(q) - F_Y^{-1}(q)| \, dq\right)^{1/p},
\]</div>
<p>where <span class="math notranslate nohighlight">\(F_X^{-1}\)</span> and <span class="math notranslate nohighlight">\(F_Y^{-1}\)</span> are the quantile functions (inverse CDFs).</p>
</div>
<br>
<p>더 이상 infimum을 구할 필요 없이 각 확률 변수의 CDF의 역함수 <span class="math notranslate nohighlight">\(F_X^{-1}(q)\)</span>와 <span class="math notranslate nohighlight">\(F_Y^{-1}(q)\)</span>를 구해서 0부터 1까지 <span class="math notranslate nohighlight">\(|F_X^{-1}(q) - F_Y^{-1}(q)|\)</span>를 적분해주면 된다.
여전히 적분 연산이 필요하지만, 더 이상 최적화 문제를 풀지 않아도 된다.
한 가지 더 좋은 점은 inverse CDFs의 차이를 0부터 1까지 적분하는 것이 그냥 CDFs의 차이를 정의역에 대해서 적분하는 것과 동일하다. 따라서 CDF만 찾아주면 된다 (아래 그림 참조, 출처 [2]).</p>
<p><img alt="../img/cdfs2.png" src="../../_images/cdfs2.png" /></p>
<br>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>참고로 CDF <span class="math notranslate nohighlight">\(F_X: \mathbb{R} \rightarrow [0, 1]\)</span>는 정의역이 증가함에 따라 함수값이 0에서 1까지 증가하는 단조 증가 함수이지만 역함수가 없을 수 있다.
정의역의 특정 구간에서 사건이 발생하지 않는다면 해당 구간에서 CDF의 값이 유지되기 때문에 일대일대응이 깨지기 때문이다.
그래서 우리는 CDF의 역함수를 일반적인 역함수와 다르게 다음과 같이 정의한다.</p>
<p>The general quantile function <span class="math notranslate nohighlight">\(F_X^{-1}: [0,1] \rightarrow \mathbb{R} \)</span> (or general inverse CDF) is defined by</p>
<div class="math notranslate nohighlight">
\[F_X^{-1}(p)=\inf \left\{ x \in \mathbb{R}: F_X(x) \ge p \right\}.\]</div>
<p>쉽게 말하면, CDF 값이 유지되는 구간에서는 가장 맨처음 값을 역함수 값으로 설정하겠다는 것이다.</p>
</div>
<p>Wasserstein distance 정의의 analytic solution이 식 <a class="reference internal" href="#equation-analytic-solution">(1)</a>이 되는 것에 대한 증명은 이 글 가장 마지막에 남겨 놓을 예정이다.</p>
<p>식 <a class="reference internal" href="#equation-analytic-solution">(1)</a> 덕분에 1차원 데이터에 대해서는 CDF를 찾아서 적분만 해주면 되게 된다…! 문제가 훨씬 쉬워졌지만,
여전히 실제 데이터에 대해 Wasserstein distance를 계산하기에는 다음 2가지 문제점이 있다.</p>
<ul class="simple">
<li><p>우리가 갖고 있는 것은 확률 분포가 아니라 데이터인데 어떻게 CDF를 찾아야 할까?</p></li>
<li><p>CDF를 찾았다고 해도 적분은 어떻게 할까?</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="id1">
<h2>Wasserstein distance 구현하기<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>먼저, 우리가 갖고 있는 데이터의 CDF를 찾는 것은 쉽다. 우리는 흔히 데이터의 분포를 보기 위해 histogram을 그려본다. 이 histogram을 데이터의 확률 분포로 보는 것이다.
데이터가 있는 부분에 상대빈도수만큼 확률을 부여하는 measure를 empirical measure라고 부른다. 직관적으로도 이해가 되기 때문에 정의를 알 필요는 없지만, 굳이 적어보면 다음과 같다.</p>
<div class="tip admonition">
<p class="admonition-title"><strong>Empirical measure</strong></p>
<p>Let <span class="math notranslate nohighlight">\(X_1, X_2, \ldots, X_n\)</span> be a sequence of independent identically distributed real-valued random variables with probability distribution <span class="math notranslate nohighlight">\(P\)</span>. The empirical measure <span class="math notranslate nohighlight">\(P_n\)</span> is defined by</p>
<div class="math notranslate nohighlight">
\[P_n(A) = {1 \over n} \sum_{i=1}^n \delta_{X_i}(A),\]</div>
<p>where <span class="math notranslate nohighlight">\(\delta_X\)</span> is the Dirac measure.</p>
</div>
<br>
<p>그럼, 주어진 1차원 데이터들의 CDF는 어떻게 계산할까? 그냥 데이터를 오름차순으로 정렬하고, 순서대로 상대빈도수를 계속 더해나가면 된다. 이쯤에서 코드 구현에 사용할 예제 데이터를 보자. x는 0, 2, 4, 6, 10에 노이즈를 추가한 것이고, y는 1, 3, 5, 7, 9에 노이즈를 추가한 것이다. 그리고 순서를 뒤죽박죽 섞어주었다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[10.65  4.6   6.54  8.42  2.72  0.55]
[5.96 7.38 9.79 3.89 1.44]
</pre></div>
</div>
</div>
</div>
<br>
<p><code class="docutils literal notranslate"><span class="pre">x</span></code>와 <code class="docutils literal notranslate"><span class="pre">y</span></code>에 대한 CDF를 구하는 방법은 굉장히 쉽다. 먼저 정렬하고, 순서대로 <span class="math notranslate nohighlight">\(\frac{1}{\text{데이터 개수}}=\frac{1}{6}\)</span>을 더해주면 된다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">cum_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">x_sorted</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cum_x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 0.55  2.72  4.6   6.54  8.42 10.65]
[0.17 0.33 0.5  0.67 0.83 1.  ]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">cum_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">y_sorted</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cum_y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1.44 3.89 5.96 7.38 9.79]
[0.2 0.4 0.6 0.8 1. ]
</pre></div>
</div>
</div>
</div>
<br>
<p>아직 끝난 것은 아니다. 우리가 갖고 있는 것은 여전히 <span class="math notranslate nohighlight">\((x, F_X(x))\)</span>, <span class="math notranslate nohighlight">\((y, F_X(y))\)</span> “데이터”이고, 진짜 CDF은 아니다.
CDF는 정의역의 모든 값에 대해 정의가 되는 반면 우리는 각 데이터에 대해서 CDF 값만 갖고 있을 뿐이다. 그림을 그려보면 다음과 같다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_sorted</span><span class="p">,</span> <span class="n">cum_x</span><span class="p">,</span> <span class="s1">&#39;bo&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_sorted</span><span class="p">,</span> <span class="n">cum_y</span><span class="p">,</span> <span class="s1">&#39;rx&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">10.9</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">1.03</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/wasserstein_distance_9_0.png" src="../../_images/wasserstein_distance_9_0.png" />
</div>
</div>
<br>
<p>하지만 우리가 원하는 CDF는 다음 그림과 같다.</p>
<a class="reference internal image-reference" href="../../_images/cdfs.png"><img alt="cdfs" class="align-center" src="../../_images/cdfs.png" style="width: 400px;" /></a>
<br>
<p>우리의 목표는 두 CDF 사이의 차이가 발생하는 영역의 넓이를 계산하는 것이다.
그런데 위 그림을 보니, 영역들이 모두 사각형인 것을 확인할 수 있다.</p>
<ul class="simple">
<li><p>데이터가 주어질 경우, CDF 사이의 차이가 발생하는 영역은 사각형이다. <br></p></li>
<li><p>사각형의 넓이를 더 쉽게 구하기 위해서는 <code class="docutils literal notranslate"><span class="pre">x</span></code> 데이터와 <code class="docutils literal notranslate"><span class="pre">y</span></code> 데이터를 모두 합쳐서 보는 것이 좋다.<br></p></li>
<li><p>사각형의 가로 길이는 <code class="docutils literal notranslate"><span class="pre">all_values[i+1]</span> <span class="pre">-</span> <span class="pre">all_values[i]</span></code>로 쉽게 구할 수 있다.</p></li>
</ul>
<p>먼저 <code class="docutils literal notranslate"><span class="pre">x</span></code>와 <code class="docutils literal notranslate"><span class="pre">y</span></code>를 합쳐놓자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
<span class="n">all_values</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">all_values</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 0.55  1.44  2.72  3.89  4.6   5.96  6.54  7.38  8.42  9.79 10.65]
</pre></div>
</div>
</div>
</div>
<br>
<p>각 사각형의 가로 길이는 <code class="docutils literal notranslate"><span class="pre">np.diff()</span></code> 함수를 통해서 쉽게 구할 수 있다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">all_values</span><span class="p">)</span>
<span class="n">deltas</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.89, 1.28, 1.18, 0.71, 1.36, 0.58, 0.84, 1.04, 1.37, 0.85])
</pre></div>
</div>
</div>
</div>
<br>
<p>하지만, 이렇게 되면 어떤 점이 <code class="docutils literal notranslate"><span class="pre">x</span></code>에서 왔는지 <code class="docutils literal notranslate"><span class="pre">y</span></code>에서 왔는지 모른다. <code class="docutils literal notranslate"><span class="pre">a.searchsorted(v)</span></code> 메서드는 <code class="docutils literal notranslate"><span class="pre">v</span></code> 배열의 각 원소가 정렬되어 있는 <code class="docutils literal notranslate"><span class="pre">a</span></code> 배열에서 크기 순서상 어느 인덱스에 위치해야 하는지 알려준다. 즉, 아래 코드에서 <code class="docutils literal notranslate"><span class="pre">x_cdf_indices</span></code>는 <code class="docutils literal notranslate"><span class="pre">all_values</span></code> 배열의 각 값이 <code class="docutils literal notranslate"><span class="pre">x_sorted</span></code> 배열에서 어디에 위치해야 하는지 적어놓은 배열이다.
<code class="docutils literal notranslate"><span class="pre">all_values</span></code>에서 <code class="docutils literal notranslate"><span class="pre">x</span></code> 배열에서 온 데이터를 마주칠 때마다 +1을 해준 배열이 된다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_cdf_indices</span> <span class="o">=</span> <span class="n">x_sorted</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">all_values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">x_cdf_indices</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1, 1, 2, 2, 3, 3, 4, 4, 5, 5])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_cdf_indices</span> <span class="o">=</span> <span class="n">y_sorted</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">all_values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">y_cdf_indices</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 1, 1, 2, 2, 3, 3, 4, 4, 5])
</pre></div>
</div>
</div>
</div>
<br>
<p>CDF는 다음과 같이 구할 수 있다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_cdf</span> <span class="o">=</span> <span class="n">x_cdf_indices</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y_cdf</span> <span class="o">=</span> <span class="n">y_cdf_indices</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">all_values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_cdf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y_cdf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.55 1.44 2.72 3.89 4.6  5.96 6.54 7.38 8.42 9.79]
[0.17 0.17 0.33 0.33 0.5  0.5  0.67 0.67 0.83 0.83]
[0.  0.2 0.2 0.4 0.4 0.6 0.6 0.8 0.8 1. ]
</pre></div>
</div>
</div>
</div>
<br>
<p>계산한 가로 길이 (<code class="docutils literal notranslate"><span class="pre">deltas</span></code>)와 CDFs (<code class="docutils literal notranslate"><span class="pre">x_cdf</span></code>, <code class="docutils literal notranslate"><span class="pre">y_cdf</span></code>)를 사용해서 <span class="math notranslate nohighlight">\(p\)</span>-Wasserstein distance를 계산해보면 다음과 같다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_cdf</span> <span class="o">-</span> <span class="n">y_cdf</span><span class="p">),</span> <span class="n">deltas</span><span class="p">))</span>
<span class="k">elif</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x_cdf</span> <span class="o">-</span> <span class="n">y_cdf</span><span class="p">),</span> <span class="n">deltas</span><span class="p">)))</span>
<span class="k">else</span><span class="p">:</span> 
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_cdf</span> <span class="o">-</span> <span class="n">y_cdf</span><span class="p">),</span> <span class="n">p</span><span class="p">),</span>
                                       <span class="n">deltas</span><span class="p">)),</span> <span class="mi">1</span><span class="o">/</span><span class="n">p</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9717676936051363
</pre></div>
</div>
</div>
</div>
<br>
<p>지금까지의 과정을 모두 합쳐서 함수로 만들어 보면 다음과 같다. 이는 실제로 SciPy에 있는 <code class="docutils literal notranslate"><span class="pre">wasserstein_distance</span></code> 함수의 간략화된 버전이다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_cdf_distance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From https://github.com/scipy/scipy/blob/v1.10.1/scipy/stats/_stats_py.py#L9165</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    
    <span class="n">all_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="n">all_values</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;mergesort&#39;</span><span class="p">)</span>

    <span class="c1"># Compute the differences between pairs of successive values of u and v.</span>
    <span class="n">deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">all_values</span><span class="p">)</span>

    <span class="c1"># Get the respective positions of the values of u and v among the values of</span>
    <span class="c1"># both distributions.</span>
    <span class="n">x_cdf_indices</span> <span class="o">=</span> <span class="n">x_sorted</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">all_values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">y_cdf_indices</span> <span class="o">=</span> <span class="n">y_sorted</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">all_values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate the CDFs of u and v using their weights, if specified.</span>
    <span class="n">x_cdf</span> <span class="o">=</span> <span class="n">x_cdf_indices</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span>
    <span class="n">y_cdf</span> <span class="o">=</span> <span class="n">y_cdf_indices</span> <span class="o">/</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span>

    <span class="c1"># Compute the value of the integral based on the CDFs.</span>
    <span class="c1"># If p = 1 or p = 2, we avoid using np.power, which introduces an overhead</span>
    <span class="c1"># of about 15%.</span>
    <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_cdf</span> <span class="o">-</span> <span class="n">y_cdf</span><span class="p">),</span> <span class="n">deltas</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x_cdf</span> <span class="o">-</span> <span class="n">y_cdf</span><span class="p">),</span> <span class="n">deltas</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_cdf</span> <span class="o">-</span> <span class="n">y_cdf</span><span class="p">),</span> <span class="n">p</span><span class="p">),</span>
                                       <span class="n">deltas</span><span class="p">)),</span> <span class="mi">1</span><span class="o">/</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">wasserstein_distance</span>

<span class="nb">print</span><span class="p">(</span><span class="n">wasserstein_distance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9717676936051363
</pre></div>
</div>
</div>
</div>
<br>
<p>이번 포스팅에서는 1차원 데이터에 대해서 두 데이터셋의 <span class="math notranslate nohighlight">\(p\)</span>-Wasserstein distance이 어떻게 계산되는지 직접 구현해보았다.
두 확률 분포에 대해서 기대 비용의 최소값으로 정의되어 있는 반면, 우리는 두 데이터셋 사이의 거리를 구하고 싶은 것이기 때문에 도저히 어떻게 구현되는지 감이 오지 않았다.
이번 포스팅을 통해서 그나마 1차원 데이터에 대해서 Wasserstein distance가 구현되는지 알 수 있게 되었다.</p>
<p>1차원을 넘어 고차원에 대해서도 어떻게 구현되는지 알아보았는데, 실제로 최적화 문제를 풀게 된다.
한 데이터셋 <span class="math notranslate nohighlight">\(X\)</span>의 각 데이터 <span class="math notranslate nohighlight">\(x\)</span>를 다른 데이터셋 <span class="math notranslate nohighlight">\(Y\)</span>의 각 데이터 <span class="math notranslate nohighlight">\(y\)</span>로 매핑하는 모든 경우의 수에 대해서 <span class="math notranslate nohighlight">\(\lVert x - y \rVert_p\)</span>의 최솟값을 구하는 문제를 풀게 된다.
기회가 된다면 고차원에 대해서도 정리를 해보도록 하겠다.</p>
</section>
<section id="id2">
<h2>식 <a class="reference internal" href="#equation-analytic-solution">(1)</a> 증명<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h2>
<p>Coming soon!</p>
<hr class="docutils" />
<br></section>
<section id="id3">
<h2>참고문헌<a class="headerlink" href="#id3" title="Permalink to this headline">#</a></h2>
<p>[1] <a class="reference external" href="https://en.wikipedia.org/wiki/Wasserstein_metric">https://en.wikipedia.org/wiki/Wasserstein_metric</a></p>
<p>[2] Marc G. Bellemare and Will Dabney and Mark Rowland, Distributional Reinforcement Learning
, MIT Press, 2022. <a class="reference external" href="https://www.distributional-rl.org/contents/chapter4.html">https://www.distributional-rl.org/contents/chapter4.html</a></p>
<p>[3] Ramdas A, Trillos NG, Cuturi M. On Wasserstein Two-Sample Testing and Related Families of Nonparametric Tests. Entropy. 2017; 19(2):47. <a class="reference external" href="https://doi.org/10.3390/e19020047">https://doi.org/10.3390/e19020047</a></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./contents/miscellaneous"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="define_and_by_run.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Define-and-run vs Define-by-run</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="quantile_regression.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Quantile Regression</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By 재야의 숨은 초보<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>